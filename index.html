<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simple AR.js App</title>
    <!-- A-Frame and AR.js libraries -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar@0.2.1-a/dist/aframe-ar.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }

        .info-box {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 10px;
        }

        .btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="ui-container">
        <div class="info-box">
            <h3 style="text-align: center; margin: 0 0 8px 0;">AR.js Simple App</h3>
            <p style="margin: 0;">Point your camera at the floor and tap to place objects</p>
        </div>
        <div class="controls">
            <button class="btn" id="cube-btn">Cube</button>
            <button class="btn" id="sphere-btn">Sphere</button>
            <button class="btn" id="cylinder-btn">Cylinder</button>
            <button class="btn" id="color-btn">Color</button>
        </div>
    </div>

    <a-scene embedded
        arjs="debugUIEnabled: false; sourceType: webcam; trackingMethod: best; detectionMode: mono_and_matrix;">
        <!-- Camera and cursor -->
        <a-entity camera>
            <a-cursor color="#4285f4"></a-cursor>
        </a-entity>

        <!-- Marker setup (using Hiro marker) -->
        <a-marker preset="hiro" id="marker">
            <a-box id="model" position="0 0.5 0" color="#4285f4"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear;"></a-box>
        </a-marker>

        <!-- Ground container for placing objects in the real world -->
        <a-entity id="ground-container"></a-entity>
    </a-scene>

    <script>
        // Global variables
        let currentShape = 'box';
        let colorIndex = 0;
        const colors = ['#4285f4', '#ea4335', '#fbbc05', '#34a853', '#ff6d01', '#46bdc6', '#7baaf7', '#f07b72'];
        let objectCount = 0;
        let groundContainer;
        let isSceneLoaded = false;

        // Prepare scene - wait for scene to fully load
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', function() {
                isSceneLoaded = true;
                groundContainer = document.getElementById('ground-container');
                
                // Add event listeners to buttons only after scene is loaded
                document.getElementById('cube-btn').addEventListener('click', () => changeModel('box'));
                document.getElementById('sphere-btn').addEventListener('click', () => changeModel('sphere'));
                document.getElementById('cylinder-btn').addEventListener('click', () => changeModel('cylinder'));
                document.getElementById('color-btn').addEventListener('click', changeColor);
                
                // Set up scene click event
                scene.addEventListener('click', function(event) {
                    if (event.target.closest('.ui-container')) return;
                    placeObject(event);
                });
            });
        });

        // Change the current shape
        function changeModel(shape) {
            if (!isSceneLoaded) {
                console.warn("Scene not fully loaded yet");
                return;
            }

            const validShapes = ['box', 'sphere', 'cylinder'];
            if (!validShapes.includes(shape)) return;

            currentShape = shape;
            
            // Find marker
            const marker = document.getElementById('marker');
            if (!marker) {
                console.warn("Marker not found");
                return;
            }

            // Find and remove existing model if present
            const model = document.getElementById('model');
            if (model) {
                model.parentNode.removeChild(model);
            }

            // Create new preview model on marker
            const newModel = document.createElement(`a-${shape}`);
            newModel.setAttribute('id', 'model');
            newModel.setAttribute('position', '0 0.5 0');
            newModel.setAttribute('color', colors[colorIndex]);
            newModel.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear;');
            marker.appendChild(newModel);
        }

        // Change color of the current shape
        function changeColor() {
            if (!isSceneLoaded) {
                console.warn("Scene not fully loaded yet");
                return;
            }
          
            colorIndex = (colorIndex + 1) % colors.length;
            const model = document.getElementById('model');
            if (model) {
                model.setAttribute('color', colors[colorIndex]);
            }
        }

        function placeObject(event) {
            if (!isSceneLoaded || !groundContainer) {
                console.warn("Scene not fully loaded yet");
                return;
            }

            // Limit number of objects to prevent performance issues
            if (objectCount >= 10) {
                const firstChild = groundContainer.firstChild;
                if (firstChild) {
                    groundContainer.removeChild(firstChild);
                }
            } else {
                objectCount++;
            }

            // Create new object based on current shape
            const newEntity = document.createElement(`a-${currentShape}`);

            // Get camera position
            const camera = document.querySelector('[camera]');
            const position = camera.getAttribute('position');
            const rotation = camera.getAttribute('rotation');

            // Calculate position in front of camera
            const distance = 1 + Math.random() * 2;
            const rotationY = rotation.y * (Math.PI / 180);
            const x = position.x - Math.sin(rotationY) * distance;
            const z = position.z - Math.cos(rotationY) * distance;

            newEntity.setAttribute('position', `${x} 0 ${z}`);
            newEntity.setAttribute('color', colors[colorIndex]);
            newEntity.setAttribute('scale', '0.5 0.5 0.5');
            newEntity.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
            newEntity.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear;');
            newEntity.setAttribute('shadow', 'cast: true; receive: false');

            // Use event listeners instead of onclick attributes
            newEntity.addEventListener('click', function() {
                const currentColor = this.getAttribute('color');
                const nextColorIndex = (colors.indexOf(currentColor) + 1) % colors.length;
                this.setAttribute('color', colors[nextColorIndex]);
            });

            groundContainer.appendChild(newEntity);
        }
    </script>
</body>

</html>